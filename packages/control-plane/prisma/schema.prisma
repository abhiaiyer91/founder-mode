generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Project {
  id               String        @id @default(cuid())
  name             String
  repoUrl          String
  defaultBranch    String
  buildCommand     String
  startCommand     String
  provider         String
  lastDeployAt     DateTime
  previewDomain    String
  productionDomain String
  organization     Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  organizationId   String?
  builds           Build[]
  deployments      Deployment[]
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
}

model Build {
  id          String      @id @default(cuid())
  project     Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId   String
  commitSha   String
  branch      String
  command     String
  startedAt   DateTime
  completedAt DateTime
  status      String
  artifactUrl String
  deployments Deployment[]
}

model Deployment {
  id            String   @id @default(cuid())
  project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId     String
  build         Build    @relation(fields: [buildId], references: [id], onDelete: Cascade)
  buildId       String
  kind          String
  status        String
  url           String
  commitMessage String
  author        String
  environment   String
  regionRollout Json
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model User {
  id              String   @id @default(cuid())
  name            String
  email           String   @unique
  emailVerified   Boolean  @default(false)
  image           String?
  username        String?  @unique
  displayUsername String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  accounts        Account[]
  sessions        Session[]
  members         Member[]
  invitationsSent Invitation[] @relation("InvitationInviter")
}

model Session {
  id                   String   @id @default(cuid())
  expiresAt            DateTime
  token                String   @unique
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  ipAddress            String?
  userAgent            String?
  activeOrganizationId String?
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId               String

  @@index([userId])
}

model Account {
  id                     String   @id @default(cuid())
  accountId              String
  providerId             String
  user                   User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId                 String
  accessToken            String?
  refreshToken           String?
  idToken                String?
  accessTokenExpiresAt   DateTime?
  refreshTokenExpiresAt  DateTime?
  scope                  String?
  password               String?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@unique([accountId, providerId])
  @@index([userId])
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
}

model Organization {
  id           String    @id @default(cuid())
  name         String
  slug         String    @unique
  logo         String?
  metadata     String?
  createdAt    DateTime  @default(now())
  members      Member[]
  invitations  Invitation[]
  projects     Project[]
}

model Member {
  id             String        @id @default(cuid())
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String
  role           String        @default("member")
  createdAt      DateTime      @default(now())

  @@index([organizationId])
  @@index([userId])
}

model Invitation {
  id             String        @id @default(cuid())
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String
  email          String
  role           String?
  status         String        @default("pending")
  expiresAt      DateTime
  createdAt      DateTime      @default(now())
  inviter        User          @relation("InvitationInviter", fields: [inviterId], references: [id], onDelete: Cascade)
  inviterId      String

  @@index([organizationId])
  @@index([email])
}
